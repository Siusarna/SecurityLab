
Лабораторна робота №5
--

Реєстрація
-- --
0. Обмеження доступу до бази даних (використання `security groups` на `AWS`).

1. Використання `rate-limits` - обмеження кількісті запитів із одного IP-адреса.
   На даний момент використана конфігурація, яка забороняє опрацьовувати більше 2 запитів в 10 хвилин для реєстрації та більше 5 запитів авторизації.

2. Валідація вхідних даних. Для ендпоінтів авторизації та реєстрації використано одну і ту ж схему валідування:

   - Будь які неочікувані поля - видалити
   - Перевірка емейлу на валідність
   - Перевірка що пароль містить хоча б 1 малу літеру, 1 велику літеру, 1 цифру, 1 спец символ.
   - Перевірка що довжина пароля більша 8 символів та менша 64.
     Згідно із `NIST SP800-63B` пароль меншої довжини вважається слабким.
     Максимальна довжина була обмежена для захисту від атаки Long password denial of service.
   - Перевірка, що даний пароль не входить в топ 10000 популярних паролів
     
3. Використання `constraint` в базі даних для забезнечення унікальності по полю email

4. Для хешування пароля було використано `argon2id`. Вибір було зроблено згідно із [OWASP](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html#argon2id). Окрім цього даний алгоритм є переможцем  Password Hashing Competition.
   Сіль було згенеровано та збережено в хеші власне алгоритмом.

5. Оскільки сучасні криптографічні алгоритми хешування не задизайнені для використання pepper,
   а неправильне використання може зробити загальну стійкість хеш функції меньшою.
   Було прийнятно рішення згенерований хеш додатково зашифровувати AES-192-cbc.
   [Link](https://stackoverflow.com/questions/16891729/best-practices-salting-peppering-passwords#:~:text=your%20own%20crypto...-,The%20Better%20Way,-So%2C%20out%20of)
   
6. Додання поля `passwordVersion` в базу даних для потенційного майбутнього використання при потребі зміни алгоритму хешування чи шифрування


Авторизація

Для авторизації використовуються пункти 1-2 із списка вище

3. Витягується користувач із бази даних за введеним емейлом.

4. Якщо такого користувача не знайдено - повертається статус 400 - Bad Request. 

5. Розшифровується пароль, витягнутий із бд.

6. За допомогою бібліотеки `argon2` виконується порівняння хеша, та введеного пароля.

Даний порядок дій піддається `time-based attack` оскільки існує `quick exit`. Для вирішення цієї проблеми потрібно: 

1. під час реєстрації не показувати помилку із текстом `User with this email has already exists`, а відправляти в будь якому випадку лист на даний емейл, а користувачу повертати `A link to activate your account has been emailed to the address provided.`. Таким чином це дозволить перевірити існуючість емейлу та не дасть інформації атакуючому ніякої інформації про існування аккаунта із даним емейлом.

2. Змінити порядок дій в алгоритмі авторизації. Наприклад повертати результат в будь-якому випадку через 5 секунд.
